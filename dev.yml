name: dev

env:
  PSB_DIR: "${HOME}/.dev/`echo $PWD | md5`"

steps:
  - spc:
      combine:
        input: builds/dev.phar
        output: builds/dev
      php:
        version: 8.3
        preset: common
        extensions:
          - swoole
          - ffi
        sources:
          swoole: https://github.com/swoole/swoole-src/archive/refs/heads/master.tar.gz
  - script:
      desc: Install composer dependencies
      run: composer install

  - script:
      desc: Create output.txt
      run: echo "Hello World $(date)" > output.txt
  - valet:
      php:
        version: 8.2
        extensions:
          pcov:
            before: |
              ln -sf $(pcre2-config --prefix)/include/pcre2.h $PHP_DIR/include/php/ext/pcre/pcre2.h
          swoole-5.1.1:
            before: |
              ln -sf $(pcre2-config --prefix)/include/pcre2.h $PHP_DIR/include/php/ext/pcre/pcre2.h
            options:
              enable-sockets: "yes"
              enable-openssl: "yes --with-openssl-dir=`find /opt/homebrew/Cellar | grep \"openssl@3/3.*.*$\" | head -n 1`"
              enable-http2: "yes"
              enable-brotli: "yes"
              enable-mysqlnd: "no"
              enable-swoole-json: "no"
              enable-swoole-curl: "yes"
              enable-cares: "no"
          redis:
            options:
              enable-redis-igbinary: no
              enable-redis-lzf: no
              enable-redis-zstd: no
              enable-redis-msgpack: no
              enable-redis-lz4: no
              with-liblz4: yes
      sites:
        - proxy: http://127.0.0.1:6001
          host: echo.phpsandbox
        - proxy: http://localhost:3000
          host: vite.phpsandbox
        - proxy: http://127.0.0.1:8006
          host: cy.phpsandbox
        - phpsandbox

commands:
  build:
    desc: Build DEV binary
    signature: "{name?} {subcommand?} {--service}"
    run: |
      php dev app:build --build-version=dev dev.phar && \
      php dev spc:combine && chmod +x builds/dev && \
      rm builds/dev.phar
  install:
    desc: Install Dev binary
    run: |
      php dev build && \
      sudo install builds/dev /usr/local/bin/dev
  php:
    desc: PHP INI_DIR
    run: echo $PHP_DIR
  build-php:
    desc: Build PHP
    run: ./scripts/build-static-cli
  style:
    desc: Fix PHP code style
    run: pint
  analyse:
    desc: PHPStan Analyse
    run: ./vendor/bin/phpstan analyse --memory-limit=2G
  test:
    desc: Run PHP tests
    run: php -d zend_extension=/opt/homebrew/lib/php/pecl/20220829/xdebug.so -d memory_limit=-1 vendor/bin/pest --coverage
  pro:
    desc: PRO
    run: echo $PSB_DIR

serve:
  write: while true; do echo "Hello, DEV! The time is $(date)" >> output.txt; sleep 1; done
  tail: tail -f output.txt

sites:
  github: https://github.com/phpsandbox/dev
